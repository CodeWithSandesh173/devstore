<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Friday Deals - Dev Store</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" href="images/icon.png" type="image/png">
</head>

<body>
    <div id="announcementBanner" class="announcement-banner" style="display: none;">
        <p id="announcementText"></p>
        <button class="close-btn" onclick="closeAnnouncement()">Ã—</button>
    </div>

    <header>
        <nav class="container">
            <div class="logo">Dev Store</div>
            <button class="nav-toggle" onclick="toggleMobileMenu()">â˜°</button>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html">Home</a></li>
                <li><a href="shop.html">Shop</a></li>
                <li><a href="blackfriday.html" class="active">Black Friday ðŸ”¥</a></li>
                <li><a href="myorders.html">My Orders</a></li>
                <li><a href="account.html">Account</a></li>
                <li><a href="login.html" id="authLink">Login</a></li>
            </ul>
        </nav>
    </header>

    <section class="section" style="background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%); color: white;">
        <div class="container text-center">
            <h1 style="color: white; font-size: 3rem;">ðŸ”¥ BLACK FRIDAY DEALS ðŸ”¥</h1>
            <p style="font-size: 1.5rem; color: rgba(255,255,255,0.9);">Limited Time Special Offers!</p>
        </div>
    </section>

    <div class="container section">
        <div id="blackFridayProducts" class="grid grid-3">
            <!-- Black Friday products will be loaded here -->
        </div>

        <div id="emptyState" style="display: none; text-align: center; padding: 3rem;">
            <h2>No Special Deals Available</h2>
            <p class="text-muted">Check back soon for amazing Black Friday deals!</p>
            <a href="shop.html" class="btn btn-primary mt-3">Browse Regular Products</a>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Dev Store</h3>
                    <p>Your trusted source for digital products</p>
                    <div class="social-links">
                        <a href="https://discord.gg/pFAVbwDu35" target="_blank" title="Discord">D</a>
                        <a href="https://www.facebook.com/profile.php?id=61585887697031" target="_blank"
                            title="Facebook">F</a>
                        <a href="https://instagram.com/devstorenepal" target="_blank" title="Instagram">I</a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <a href="shop.html">Shop</a>
                    <a href="myorders.html">My Orders</a>
                    <a href="account.html">Account</a>
                    <a href="legal.html">Legal</a>
                </div>
                <div class="footer-section">
                    <h3>Support</h3>
                    <p>24/7 customer support available</p>
                    <p>Contact us anytime via chat</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 Dev Store. All rights reserved.</p>
            </div>
        </div>
    </footer>


    <div class="chat-widget">
        <button class="chat-toggle" onclick="toggleChat()">ðŸ’¬</button>
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">24/7 Support</div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Type your message...">
                <button class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/products.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/announcements.js"></script>

    <script>
        function toggleMobileMenu() {
            document.getElementById('navLinks').classList.toggle('active');
        }

        function buyBlackFridayDeal(dealId) {
            database.ref(`blackFriday/${dealId}`).once('value').then(snapshot => {
                const deal = snapshot.val();
                if (!deal) return;

                // Create the order item with deal price
                // Need to fetch requirements from product?
                // If we saved productId, we can look it up in productsData array from products.js (since we included it)
                // Or fetch from DB. productsData is available synchronously if products.js is loaded.

                let requirements = "Email"; // Fallback

                // Try to find product in local productsData if available
                if (typeof productsData !== 'undefined' && deal.productId) {
                    const product = productsData.find(p => p.id === deal.productId);
                    if (product) requirements = product.requirements;
                } else if (!deal.productId) {
                    // Fallback for old deals without ID - verify by name
                    const product = productsData.find(p => p.name === deal.name);
                    if (product) requirements = product.requirements;
                }

                const orderItem = {
                    productId: deal.productId || 'bf_deal',
                    productName: deal.name,
                    package: deal.package,
                    price: deal.discountedPrice,
                    requirements: requirements,
                    image: deal.image,
                    isBlackFriday: true
                };

                // Save and redirect
                localStorage.setItem('directBuyItem', JSON.stringify(orderItem));

                // Auth check
                const user = firebase.auth().currentUser;
                if (!user) {
                    if (confirm('Please login to grab this deal!')) {
                        window.location.href = 'login.html';
                    }
                } else {
                    window.location.href = 'checkout.html';
                }
            });
        }

        onAuthStateChanged(user => {
            const authLink = document.getElementById('authLink');
            if (user) {
                authLink.textContent = 'Logout';
                authLink.onclick = async (e) => {
                    e.preventDefault();
                    await logoutUser();
                    window.location.reload();
                };
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            loadBlackFridayProducts();
            loadAnnouncement();
        });

        function loadBlackFridayProducts() {
            database.ref('blackFriday').once('value')
                .then(snapshot => {
                    const container = document.getElementById('blackFridayProducts');
                    const emptyState = document.getElementById('emptyState');

                    if (!snapshot.exists()) {
                        container.innerHTML = '';
                        emptyState.style.display = 'block';
                        return;
                    }

                    container.innerHTML = '';
                    emptyState.style.display = 'none';

                    snapshot.forEach(child => {
                        const deal = child.val();

                        const usdOriginal = (deal.originalPrice / 145).toFixed(2);
                        const usdDiscount = (deal.discountedPrice / 145).toFixed(2);

                        const card = document.createElement('div');
                        card.className = 'product-card card';
                        card.innerHTML = `
                            <img src="${deal.image}" alt="${deal.name}">
                            <h3>${deal.name}</h3>
                            <p class="text-muted">${deal.package}</p>
                            <p style="text-decoration: line-through; color: var(--color-text-light);">$${usdOriginal}</p>
                            <p class="price" style="color: var(--color-danger);">$${usdDiscount}</p>
                            <p class="text-success"><strong>Save ${Math.round((1 - deal.discountedPrice / deal.originalPrice) * 100)}%!</strong></p>
                            <button onclick="buyBlackFridayDeal('${child.key}')" class="btn btn-primary">Shop Now</button>
                        `;
                        container.appendChild(card);
                    });
                })
                .catch(error => console.error('Error loading Black Friday deals:', error));
        }
    </script>
</body>

</html>